name: Release Stage

on:
  workflow_dispatch:
    inputs:
      rc_version:
        description: 'RC version to promote (e.g., 1.0.5-rc.47, or leave blank for latest RC)'
        required: false
        type: string

jobs:
  promote-rc-to-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    env:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find latest RC version if not provided
      id: find-rc
      uses: ./.github/actions/find-latest-rc-version
      with:
        rc-version: ${{ github.event.inputs.rc_version }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        package-name: 'com.optivem.optivem-test'
      
    - name: Validate inputs
      id: validate
      uses: ./.github/actions/validate-rc-version
      with:
        rc-version: ${{ steps.find-rc.outputs.rc-version }}
        
    - name: Check if release version already exists
      uses: ./.github/actions/check-release-exists
      with:
        release-version: ${{ steps.validate.outputs.release-version }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download RC artifacts
      uses: ./.github/actions/download-rc-artifacts
      with:
        rc-version: ${{ steps.validate.outputs.rc-version }}
        github-username: ${{ github.actor }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Prepare release artifacts
      uses: ./.github/actions/prepare-release-artifacts
      with:
        rc-version: ${{ steps.validate.outputs.rc-version }}
        release-version: ${{ steps.validate.outputs.release-version }}
      
    - name: Upload release to Maven Central
      id: upload
      uses: ./.github/actions/upload-to-maven-central
      with:
        release-version: ${{ steps.validate.outputs.release-version }}
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: ${{ secrets.GPG_PASSPHRASE }}
    
    - name: Wait for deployment validation
      uses: ./.github/actions/wait-for-deployment-validation
      with:
        deployment-id: ${{ steps.upload.outputs.deployment-id }}
        expected-state: 'VALIDATED'
        max-attempts: '60'
        poll-interval: '10'
    
    - name: Publish deployment on Maven Central
      uses: ./.github/actions/publish-central-deployment
      with:
        deployment-id: ${{ steps.upload.outputs.deployment-id }}
        release-version: ${{ steps.validate.outputs.release-version }}
    
    - name: Wait for publishing to start
      uses: ./.github/actions/wait-for-deployment-validation
      with:
        deployment-id: ${{ steps.upload.outputs.deployment-id }}
        expected-state: 'PUBLISHING'
        max-attempts: '60'
        poll-interval: '10'
    
    - name: Wait for publishing to complete
      uses: ./.github/actions/wait-for-deployment-validation
      with:
        deployment-id: ${{ steps.upload.outputs.deployment-id }}
        expected-state: 'PUBLISHED'
        max-attempts: '60'
        poll-interval: '60'
        
    - name: Wait for Maven Central availability
      uses: ./.github/actions/wait-for-maven-central
      with:
        release-version: ${{ steps.validate.outputs.release-version }}
        max-attempts: '120'
        poll-interval: '60'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper
        
    - name: Make gradlew executable
      run: chmod +x gradlew
        
    - name: Run release smoke tests (Maven Central)
      run: |
        echo "ðŸ§ª Running release smoke tests..."
        ./gradlew system-test:smoke-test-release:test --no-daemon -Pversion="${{ steps.validate.outputs.release-version }}"
        
    - name: Create Git tag
      uses: ./.github/actions/create-git-tag
      with:
        release-version: ${{ steps.validate.outputs.release-version }}
        rc-version: ${{ steps.validate.outputs.rc-version }}
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.validate.outputs.release-version }}
        name: Release ${{ steps.validate.outputs.release-version }}
        body: |
          ðŸŽ‰ **Release ${{ steps.validate.outputs.release-version }}**
          
          This release was promoted from RC version `${{ steps.validate.outputs.rc-version }}` after passing all acceptance tests.
          
          **Promoted Artifacts:**
          - Same exact JAR that passed testing
          - No rebuild - identical artifacts guaranteed
          - âœ… Automatically published to Maven Central
          
          **Next Steps:**
          ðŸ§ª Verify availability: `.\trigger-verification.ps1 -Version "${{ steps.validate.outputs.release-version }}"`
          
          **Note:** Maven Central synchronization may take a few minutes to hours.
        files: |
          core/build/libs/*.jar
        generate_release_notes: true
        draft: false
        prerelease: false
        
    - name: Display next steps
      shell: pwsh
      run: |
        $releaseVersion = "${{ steps.validate.outputs.release-version }}"
        Write-Host ""
        Write-Host "ðŸŽ‰ Release promotion completed successfully!" -ForegroundColor Green
        Write-Host ""
        Write-Host "ðŸ“‹ What happened:" -ForegroundColor Cyan
        Write-Host "1. âœ… Downloaded RC artifacts from GitHub Packages" -ForegroundColor White
        Write-Host "2. âœ… Uploaded and published to Maven Central (same artifacts, no rebuild)" -ForegroundColor White
        Write-Host "3. âœ… Created Git tag v${releaseVersion}" -ForegroundColor White
        Write-Host "4. âœ… Created GitHub Release" -ForegroundColor White
        Write-Host ""
        Write-Host "ðŸ“‹ Next Steps:" -ForegroundColor Cyan
        Write-Host "1. â³ Wait a few minutes for Maven Central synchronization" -ForegroundColor White
        Write-Host "2. ðŸ§ª Verify: .\trigger-verification.ps1 -Version `"${releaseVersion}`"" -ForegroundColor White
        Write-Host ""
        Write-Host "âœ… Same artifacts that passed RC testing are now released!" -ForegroundColor Green
        
    - name: Create release summary
      run: |
        echo "## ðŸŽ‰ Release Stage Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Release Version:** \`${{ steps.validate.outputs.release-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Promoted from RC:** \`${{ steps.validate.outputs.rc-version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Release Activities:**" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Downloaded RC artifacts from GitHub Packages" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Uploaded and published to Maven Central" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Created Git tag v${{ steps.validate.outputs.release-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Created GitHub Release" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Ran release smoke tests" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ðŸŽ‰ Release published successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "- â³ Wait for Maven Central synchronization (may take a few minutes to hours)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ§ª Verify availability using: \`trigger-verification.ps1 -Version \"${{ steps.validate.outputs.release-version }}\"\`" >> $GITHUB_STEP_SUMMARY