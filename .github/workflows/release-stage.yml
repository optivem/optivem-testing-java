name: Release Stage

on:
  workflow_dispatch:
    inputs:
      rc_version:
        description: 'RC version to promote (e.g., 1.0.5-rc.47)'
        required: true
        type: string

jobs:
  promote-rc-to-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: 21
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: wrapper
        
    - name: Validate inputs
      id: validate
      uses: ./.github/actions/validate-rc-version
      with:
        rc-version: ${{ github.event.inputs.rc_version }}
        
    - name: Check if release version already exists
      uses: ./.github/actions/check-release-exists
      with:
        release-version: ${{ steps.validate.outputs.release-version }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download RC artifacts
      uses: ./.github/actions/download-rc-artifacts
      with:
        rc-version: ${{ steps.validate.outputs.rc-version }}
        github-username: ${{ github.actor }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Prepare release artifacts
      uses: ./.github/actions/prepare-release-artifacts
      with:
        rc-version: ${{ steps.validate.outputs.rc-version }}
        release-version: ${{ steps.validate.outputs.release-version }}
        
    - name: Publish release to GitHub Packages
      run: |
        echo "üöÄ Publishing release to GitHub Packages..."
        RELEASE_VERSION="${{ steps.validate.outputs.release-version }}"
        ./gradlew core:publishMavenPublicationToGitHubPackagesRepository --no-daemon -Pversion="${RELEASE_VERSION}"
      env:
        GITHUB_USERNAME: ${{ github.actor }}
        GITHUB_WRITE_PACKAGES_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload release to Maven Central
      run: |
        echo "üì§ Uploading release to Maven Central..."
        RELEASE_VERSION="${{ steps.validate.outputs.release-version }}"
        ./gradlew core:uploadToCentralPortal --no-daemon --no-configuration-cache -Pversion="${RELEASE_VERSION}"
      env:
        SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
        SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        
    - name: Run release smoke tests
      run: |
        echo "üß™ Running release smoke tests..."
        ./gradlew system-test:smoke-test-release-github:test --no-daemon
      env:
        GITHUB_USERNAME: ${{ github.actor }}
        GITHUB_READ_PACKAGES_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Git tag and release
      shell: pwsh
      run: |
        $releaseVersion = "${{ steps.validate.outputs.release-version }}"
        $rcVersion = "${{ steps.validate.outputs.rc-version }}"
        
        Write-Host "üè∑Ô∏è Creating Git tag v${releaseVersion}..." -ForegroundColor Blue
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        git tag -a "v${releaseVersion}" -m "Release ${releaseVersion} (promoted from ${rcVersion})"
        git push origin "v${releaseVersion}"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.validate.outputs.release-version }}
        name: Release ${{ steps.validate.outputs.release-version }}
        body: |
          üéâ **Release ${{ steps.validate.outputs.release-version }}**
          
          This release was promoted from RC version `${{ steps.validate.outputs.rc-version }}` after passing all acceptance tests.
          
          **Promoted Artifacts:**
          - Same exact JAR that passed testing
          - No rebuild - identical artifacts guaranteed
          
          **Next Steps:**
          üì§ Manually publish in [Central Portal](https://central.sonatype.com/publishing/deployments)  
          üß™ Then verify: `.\trigger-verification.ps1 -Version "${{ steps.validate.outputs.release-version }}"`
        files: |
          core/build/libs/*.jar
        generate_release_notes: true
        draft: false
        prerelease: false
        
    - name: Display next steps
      shell: pwsh
      run: |
        $releaseVersion = "${{ steps.validate.outputs.release-version }}"
        Write-Host ""
        Write-Host "üéâ Release promotion completed successfully!" -ForegroundColor Green
        Write-Host ""
        Write-Host "üìã Next Steps:" -ForegroundColor Cyan
        Write-Host "1. üåê Go to: https://central.sonatype.com/publishing/deployments" -ForegroundColor White
        Write-Host "2. üì§ Manually publish version: ${releaseVersion}" -ForegroundColor White
        Write-Host "3. üß™ Verify: .\trigger-verification.ps1 -Version `"${releaseVersion}`"" -ForegroundColor White
        Write-Host ""
        Write-Host "‚úÖ Same artifacts that passed RC testing are now released!" -ForegroundColor Green